# @repo/database

Shared database package for the monorepo, providing type-safe database access using Drizzle ORM.

## Architecture

This package separates **runtime code** from **CLI tools**:

### Runtime (Application Code)
- **Purpose**: Used by applications at runtime to connect to the database
- **File**: `src/client.ts`
- **Pattern**: Apps pass validated connection strings
- **Environment**: NO environment variables accessed in package code

```typescript
// In your app (e.g., apps/auth/src/lib/db.ts)
import { createDbClient } from "@repo/database";
import { env } from "../env"; // App validates env

export const db = createDbClient(env.DATABASE_URL);
```

### CLI Tools (Development/Migration)
- **Purpose**: Database management tools (migrations, schema inspection)
- **File**: `drizzle.config.ts`
- **Pattern**: Uses environment variables for CLI commands
- **Environment**: Configured via Turborepo (see `turbo.json`)

## Usage

### For Applications (Runtime)

```typescript
import { createDbClient } from "@repo/database";

// App is responsible for validating and passing the connection string
const db = createDbClient(validatedConnectionString);

// Use Drizzle ORM
const users = await db.select().from(schema.user);
```

### For CLI Tools (Development)

The package provides CLI commands that use environment variables:

```bash
# Generate SQL migrations from schema changes
pnpm db:generate

# Apply migrations to database
pnpm db:migrate

# Open Drizzle Studio (database GUI)
pnpm db:studio
```

**Environment Setup** (Turborepo Pattern):

Create a `.env` file in **root** or **apps/auth/**:

```env
DATABASE_URL=postgresql://postgres:password@localhost:5432/auth_db
```

Turborepo automatically passes `DATABASE_URL` to these tasks (configured in `turbo.json`):

```json
{
  "tasks": {
    "db:generate": {
      "env": ["DATABASE_URL"]
    },
    "db:migrate": {
      "env": ["DATABASE_URL"]
    },
    "db:studio": {
      "env": ["DATABASE_URL"]
    }
  }
}
```

### Running from Root

```bash
# From repository root
pnpm db:migrate  # Runs for all packages with this script
pnpm --filter @repo/database db:studio  # Run for specific package
```

### Running from Package

```bash
# From packages/database/
pnpm db:studio  # Opens Drizzle Studio
```

## Schema Management

### Overview

The database schema uses a two-tier approach:

1. **Auth Tables** (Generated): `src/schema/auth.ts` - Generated by Better Auth CLI
2. **Custom Tables** (Manual): `src/schema/resources.ts` - Your application-specific tables
3. **Unified Export**: `src/schema/index.ts` - Re-exports both schemas

### Complete Workflow

#### 1. Generate Auth Schema (from auth server)

Better Auth generates the authentication tables (`user`, `session`, `account`, `verification`):

```bash
# From repository root
pnpm db:schema

# Or manually from apps/auth
cd apps/auth
npx @better-auth/cli generate --output ../../packages/database/src/schema/auth.ts
```

This creates/updates `packages/database/src/schema/auth.ts` with tables needed for authentication.

#### 2. Generate Migrations

After schema changes (auth tables or custom tables), generate SQL migrations:

```bash
# From repository root
pnpm db:generate

# Or from packages/database
cd packages/database
pnpm db:generate
```

This creates timestamped SQL files in `drizzle/migrations/`.

#### 3. Apply Migrations

Apply pending migrations to your database:

```bash
# From repository root
pnpm db:migrate

# Or from packages/database
cd packages/database
pnpm db:migrate
```

### Adding Custom Fields to Auth Tables

Better Auth supports extending auth tables with custom fields:

```typescript
// In apps/auth/src/lib/auth.ts
export const auth = betterAuth({
  // ... other config
  user: {
    additionalFields: {
      role: {
        type: "string",
        required: false,
        defaultValue: "user",
      },
      onboardingCompleted: {
        type: "boolean",
        required: false,
        defaultValue: false,
      },
    },
  },
});
```

After adding fields:
1. Run `pnpm db:schema` to regenerate schema
2. Run `pnpm db:generate` to create migration
3. Run `pnpm db:migrate` to apply changes

### Adding Custom Tables

Add your own tables in `packages/database/src/schema/resources.ts`:

```typescript
import { pgTable, text, timestamp, uuid } from "drizzle-orm/pg-core";

export const posts = pgTable("posts", {
  id: uuid("id").primaryKey().defaultRandom(),
  title: text("title").notNull(),
  content: text("content"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
});
```

After adding tables, run `pnpm db:generate` and `pnpm db:migrate`.

### Migration Rollback

**Important**: Drizzle Kit does not support automatic rollbacks. To rollback:

#### Option 1: Manual Rollback (Recommended for Development)

1. **Identify the migration to rollback**:
   ```bash
   ls packages/database/drizzle/migrations/
   ```

2. **Manually write a down migration**:
   ```sql
   -- In drizzle/migrations/XXXX_rollback.sql
   DROP TABLE IF EXISTS new_table;
   ALTER TABLE users DROP COLUMN IF EXISTS new_field;
   ```

3. **Run the rollback SQL**:
   ```bash
   psql $DATABASE_URL -f packages/database/drizzle/migrations/XXXX_rollback.sql
   ```

#### Option 2: Restore from Backup (Production)

For production environments, restore from database backup:

```bash
# Create backup before migration
pg_dump $DATABASE_URL > backup_$(date +%Y%m%d_%H%M%S).sql

# Restore if needed
psql $DATABASE_URL < backup_YYYYMMDD_HHMMSS.sql
```

#### Option 3: Generate Reverse Migration

1. Revert schema changes in code
2. Run `pnpm db:generate` to create new migration
3. Apply with `pnpm db:migrate`

### Complete Setup Workflow

For a fresh database setup:

```bash
# 1. Start PostgreSQL
docker run -d \
  --name auth-postgres \
  -e POSTGRES_PASSWORD=password \
  -e POSTGRES_DB=auth_db \
  -p 5432:5432 \
  postgres:18

# 2. Set environment variable
export DATABASE_URL=postgresql://postgres:password@localhost:5432/auth_db

# 3. Run complete setup (from repository root)
pnpm db:setup  # Runs: db:schema → db:generate → db:migrate
```

## Key Points

✅ **Runtime code**: Package exports utilities, apps pass configuration
✅ **CLI tools**: Package uses environment variables for development tasks
✅ **Turborepo**: Automatically passes `DATABASE_URL` to CLI tasks
✅ **Type safety**: Full TypeScript support with Drizzle ORM
✅ **Separation**: Clear boundary between runtime and CLI usage

## Files

- `src/client.ts` - Database client factory (runtime)
- `src/schema/index.ts` - Re-exports generated schema
- `drizzle.config.ts` - Drizzle Kit CLI configuration
- `drizzle/schema.ts` - Generated by better-auth CLI
- `drizzle/migrations/` - SQL migration files

## Dependencies

- `drizzle-orm` - Type-safe ORM
- `postgres` - PostgreSQL client (postgres.js)
- `drizzle-kit` - CLI tools for migrations and studio
